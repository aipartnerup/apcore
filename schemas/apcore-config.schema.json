{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://apcore.dev/schemas/apcore-config.schema.json",
  "title": "apcore Configuration Schema",
  "description": "JSON Schema for validating apcore.yaml configuration files. Based on PROTOCOL_SPEC Section 8.",
  "type": "object",
  "required": ["version", "project", "extensions", "schema", "acl"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Configuration schema reference URL.",
      "const": "https://apcore.dev/config/v1"
    },
    "version": {
      "type": "string",
      "description": "Configuration version. MUST follow semver format.",
      "pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.]+)?(\\+[a-zA-Z0-9.]+)?$",
      "examples": ["1.0.0"]
    },
    "project": {
      "$ref": "#/$defs/ProjectConfig"
    },
    "extensions": {
      "$ref": "#/$defs/ExtensionsConfig"
    },
    "schema": {
      "$ref": "#/$defs/SchemaConfig"
    },
    "acl": {
      "$ref": "#/$defs/ACLConfig"
    },
    "logging": {
      "$ref": "#/$defs/LoggingConfig"
    },
    "observability": {
      "$ref": "#/$defs/ObservabilityConfig"
    },
    "middleware": {
      "$ref": "#/$defs/MiddlewareConfig"
    },
    "executor": {
      "$ref": "#/$defs/ExecutorConfig"
    },
    "id_map": {
      "$ref": "#/$defs/IDMapConfig"
    }
  },
  "$defs": {
    "ProjectConfig": {
      "type": "object",
      "description": "Project information.",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Project name. MUST match the pattern: lowercase letters, digits, hyphens, and underscores.",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "minLength": 1,
          "maxLength": 64,
          "examples": ["my-ai-project"]
        },
        "version": {
          "type": "string",
          "description": "Project version. SHOULD follow semver format.",
          "pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.]+)?(\\+[a-zA-Z0-9.]+)?$",
          "examples": ["0.1.0"]
        }
      }
    },
    "ExtensionsConfig": {
      "type": "object",
      "description": "Extensions discovery and loading configuration. Supports single root (backward compatible) or multiple roots with namespace isolation.",
      "additionalProperties": false,
      "oneOf": [
        {
          "required": ["root"],
          "description": "Single root mode (backward compatible). No namespace by default.",
          "properties": {
            "root": {
              "type": "string",
              "description": "Extensions root directory path. MUST be a valid directory.",
              "default": "./extensions",
              "examples": ["./extensions"]
            },
            "namespace": {
              "type": "string",
              "description": "Namespace for modules under this root. Omit for no namespace (backward compatible). When set, all module IDs are prefixed with this namespace (e.g., namespace 'core' → 'core.executor.email.send').",
              "pattern": "^[a-z][a-z0-9_]*$",
              "examples": ["core"]
            }
          }
        },
        {
          "required": ["roots"],
          "description": "Multi-root mode with namespace isolation. Each root auto-derives namespace from its directory name unless explicitly overridden.",
          "properties": {
            "roots": {
              "type": "array",
              "description": "Multiple extension root directories. Each entry is either a path string (namespace auto-derived from directory name) or an object with explicit namespace override.",
              "items": {
                "oneOf": [
                  {
                    "type": "string",
                    "description": "Directory path. Namespace is auto-derived from the last path segment (e.g., './extensions' → namespace 'extensions')."
                  },
                  {
                    "type": "object",
                    "required": ["root"],
                    "additionalProperties": false,
                    "properties": {
                      "root": {
                        "type": "string",
                        "description": "Extensions root directory path."
                      },
                      "namespace": {
                        "type": "string",
                        "description": "Override auto-derived namespace. Empty string means no namespace prefix (allowed for at most one root in multi-root mode).",
                        "pattern": "^([a-z][a-z0-9_]*)?$"
                      }
                    }
                  }
                ]
              },
              "minItems": 1,
              "examples": [
                ["./extensions", "./plugins"],
                [{"root": "./extensions", "namespace": "core"}, "./plugins"]
              ]
            }
          }
        }
      ],
      "properties": {
        "auto_discover": {
          "type": "boolean",
          "description": "Whether to automatically discover modules in the extensions directory.",
          "default": true
        },
        "lazy_load": {
          "type": "boolean",
          "description": "Whether to lazily load modules (load on first call instead of at startup).",
          "default": true
        },
        "follow_symlinks": {
          "type": "boolean",
          "description": "Whether to follow symbolic links during scanning. MUST NOT default to true.",
          "default": false
        },
        "max_depth": {
          "type": "integer",
          "description": "Maximum directory scan depth under extensions root.",
          "default": 8,
          "minimum": 1,
          "maximum": 16
        },
        "ignore_patterns": {
          "type": "array",
          "description": "Additional file/directory patterns to ignore during scanning.",
          "items": {
            "type": "string"
          },
          "default": [],
          "examples": [["*.test.*", "*.spec.*"]]
        }
      }
    },
    "SchemaConfig": {
      "type": "object",
      "description": "Schema loading and validation configuration.",
      "required": ["root"],
      "additionalProperties": false,
      "properties": {
        "root": {
          "type": "string",
          "description": "Schema files root directory path.",
          "default": "./schemas",
          "examples": ["./schemas"]
        },
        "strategy": {
          "type": "string",
          "description": "Schema loading strategy. yaml_first: prefer YAML, fallback to native. native_first: prefer native, fallback to YAML. yaml_only: only YAML schemas.",
          "enum": ["yaml_first", "native_first", "yaml_only"],
          "default": "yaml_first"
        },
        "validation": {
          "type": "object",
          "description": "Schema validation options.",
          "additionalProperties": false,
          "properties": {
            "strict": {
              "type": "boolean",
              "description": "Strict mode: reject additional properties not defined in schema.",
              "default": true
            },
            "coerce_types": {
              "type": "boolean",
              "description": "Whether to coerce types during validation (e.g., string '1' to integer 1).",
              "default": true
            }
          }
        },
        "max_ref_depth": {
          "type": "integer",
          "description": "Maximum $ref recursion depth for schema resolution.",
          "default": 32,
          "minimum": 1,
          "maximum": 128
        }
      }
    },
    "ACLConfig": {
      "type": "object",
      "description": "Access Control List configuration.",
      "required": ["root"],
      "additionalProperties": false,
      "properties": {
        "root": {
          "type": "string",
          "description": "ACL configuration files directory path.",
          "default": "./acl",
          "examples": ["./acl"]
        },
        "default_effect": {
          "type": "string",
          "description": "Default ACL effect when no rule matches. MUST be 'allow' or 'deny'.",
          "enum": ["allow", "deny"],
          "default": "deny"
        },
        "audit": {
          "type": "object",
          "description": "ACL audit logging configuration.",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether to enable ACL audit logging.",
              "default": true
            },
            "log_level": {
              "type": "string",
              "description": "Audit log level.",
              "enum": ["trace", "debug", "info", "warn", "error"],
              "default": "info"
            },
            "include_denied": {
              "type": "boolean",
              "description": "Whether to log denied access attempts.",
              "default": true
            }
          }
        }
      }
    },
    "LoggingConfig": {
      "type": "object",
      "description": "Logging configuration.",
      "additionalProperties": false,
      "properties": {
        "level": {
          "type": "string",
          "description": "Global log level.",
          "enum": ["trace", "debug", "info", "warn", "error", "fatal"],
          "default": "info"
        },
        "format": {
          "type": "string",
          "description": "Log output format.",
          "enum": ["json", "text"],
          "default": "json"
        }
      }
    },
    "ObservabilityConfig": {
      "type": "object",
      "description": "Observability configuration for tracing and metrics.",
      "additionalProperties": false,
      "properties": {
        "tracing": {
          "type": "object",
          "description": "Distributed tracing configuration.",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether to enable distributed tracing.",
              "default": true
            },
            "sampling_rate": {
              "type": "number",
              "description": "Trace sampling rate. 0.0 = no sampling, 1.0 = sample everything.",
              "minimum": 0.0,
              "maximum": 1.0,
              "default": 1.0
            },
            "exporter": {
              "type": "string",
              "description": "Trace exporter backend.",
              "enum": ["stdout", "otlp", "jaeger"],
              "default": "stdout"
            }
          }
        },
        "metrics": {
          "type": "object",
          "description": "Metrics collection configuration.",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether to enable metrics collection.",
              "default": true
            },
            "exporter": {
              "type": "string",
              "description": "Metrics exporter backend.",
              "enum": ["stdout", "prometheus", "otlp"],
              "default": "stdout"
            }
          }
        }
      }
    },
    "MiddlewareConfig": {
      "type": "object",
      "description": "Middleware configuration.",
      "additionalProperties": false,
      "properties": {
        "disabled": {
          "type": "array",
          "description": "List of built-in middleware IDs to disable. Framework-required middleware (schema_validation, acl_check) cannot be disabled.",
          "items": {
            "type": "string"
          },
          "default": []
        }
      }
    },
    "ExecutorConfig": {
      "type": "object",
      "description": "Executor runtime configuration for call chain safety and execution limits.",
      "additionalProperties": false,
      "properties": {
        "max_call_depth": {
          "type": "integer",
          "description": "Maximum call chain depth. Calls exceeding this depth are rejected with CALL_DEPTH_EXCEEDED.",
          "default": 32,
          "minimum": 1,
          "maximum": 128
        },
        "max_module_repeat": {
          "type": "integer",
          "description": "Maximum number of times the same module ID can appear in a single call chain. Exceeding this triggers CALL_FREQUENCY_EXCEEDED. Prevents non-strict cyclic patterns in AI orchestration scenarios.",
          "default": 3,
          "minimum": 1,
          "maximum": 32
        }
      }
    },
    "IDMapConfig": {
      "type": "object",
      "description": "Cross-language ID mapping configuration.",
      "additionalProperties": false,
      "properties": {
        "auto_detect": {
          "type": "boolean",
          "description": "Whether to automatically detect language from file extension.",
          "default": true
        },
        "overrides": {
          "type": "object",
          "description": "Manual ID mapping overrides. Keys are Canonical IDs, values are language-specific mappings.",
          "additionalProperties": {
            "type": "object",
            "description": "Language-specific mapping for a module.",
            "additionalProperties": {
              "type": "object",
              "properties": {
                "class": {
                  "type": "string",
                  "description": "Fully qualified class/struct name."
                },
                "package": {
                  "type": "string",
                  "description": "Package name (Java/Go)."
                },
                "module": {
                  "type": "string",
                  "description": "Module path (Rust)."
                }
              }
            }
          },
          "default": {}
        }
      }
    }
  }
}
